#include "reg51.h"
#include "intrins.h" 
#define uchar unsigned char
#define uint unsigned int
#define LCD_data P0

#define AM(X) X
#define PM(X) (X+12)   // 转成24小时制
#define DS1302_SECOND 0x80	   //用于计算ds1302RAM地址
#define DS1302_MINUTE 0x82
#define DS1302_HOUR  0x84 
#define DS1302_WEEK  0x8A
#define DS1302_DAY  0x86
#define DS1302_MONTH 0x88
#define DS1302_YEAR  0x8C
#define DS1302_RAM(X) (0xC0+(X)*2)    

uchar code GongLi[]={
0x00,0x00,0xF0,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xF0,0x00,0x00,0x00 ,0x00,0x00,0x3F,0x20,0x20,0x20,0x20,0x3F,0x20,0x20,0x20,0x20,0x7F,0x00,0x00,0x00 ,/*"山",0*/0x20,0x20,0x20,0x20,0x20,0x20,0x20,0xFF,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x00 ,0x80,0x80,0x40,0x20,0x10,0x0C,0x03,0x00,0x03,0x0C,0x10,0x20,0x40,0x80,0x80,0x00 ,/*"大",1*/
/*--  文字:  公  --*/
/*--  宋体12;  此字体下对应的点阵为：宽x高=16x16   --*/
0x00,0x80,0x40,0x20,0x18,0x06,0x80,0x00,0x07,0x18,0x20,0x40,0x80,0x00,0x00,0x00,
0x01,0x00,0x20,0x70,0x28,0x26,0x21,0x20,0x20,0x24,0x38,0x60,0x00,0x01,0x01,0x00,

/*--  文字:  历  --*/
/*--  宋体12;  此字体下对应的点阵为：宽x高=16x16   --*/
0x00,0x00,0xFE,0x02,0x42,0x42,0x42,0x42,0xFA,0x42,0x42,0x42,0x42,0xC2,0x02,0x00,
0x80,0x60,0x1F,0x80,0x40,0x20,0x18,0x06,0x01,0x00,0x40,0x80,0x40,0x3F,0x00,0x00,

/*--  文字:  星  --*/
/*--  宋体12;  此字体下对应的点阵为：宽x高=16x16   --*/
0x00,0x00,0x00,0xBE,0x2A,0x2A,0x2A,0xEA,0x2A,0x2A,0x2A,0x3E,0x00,0x00,0x00,0x00,
0x00,0x44,0x42,0x49,0x49,0x49,0x49,0x7F,0x49,0x49,0x49,0x49,0x41,0x40,0x00,0x00,

/*--  文字:  期  --*/
/*--  宋体12;  此字体下对应的点阵为：宽x高=16x16   --*/
0x00,0x04,0xFF,0x24,0x24,0x24,0xFF,0x04,0x00,0xFE,0x22,0x22,0x22,0xFE,0x00,0x00,
0x88,0x48,0x2F,0x09,0x09,0x19,0xAF,0x48,0x30,0x0F,0x02,0x42,0x82,0x7F,0x00,0x00,

/*--  文字:  一  --*/
/*--  宋体12;  此字体下对应的点阵为：宽x高=16x16   --*/
0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,

/*--  文字:  二  --*/
/*--  宋体12;  此字体下对应的点阵为：宽x高=16x16   --*/
0x00,0x00,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x00,0x00,0x00,
0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x00,

/*--  文字:  三  --*/
/*--  宋体12;  此字体下对应的点阵为：宽x高=16x16   --*/
0x00,0x04,0x84,0x84,0x84,0x84,0x84,0x84,0x84,0x84,0x84,0x84,0x84,0x04,0x00,0x00,
0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x00,

/*--  文字:  四  --*/
/*--  宋体12;  此字体下对应的点阵为：宽x高=16x16   --*/
0x00,0xFC,0x04,0x04,0x04,0xFC,0x04,0x04,0x04,0xFC,0x04,0x04,0x04,0xFC,0x00,0x00,
0x00,0x7F,0x28,0x24,0x23,0x20,0x20,0x20,0x20,0x21,0x22,0x22,0x22,0x7F,0x00,0x00,

/*--  文字:  五  --*/
/*--  宋体12;  此字体下对应的点阵为：宽x高=16x16   --*/
0x00,0x02,0x42,0x42,0x42,0xC2,0x7E,0x42,0x42,0x42,0x42,0xC2,0x02,0x02,0x00,0x00,
0x40,0x40,0x40,0x40,0x78,0x47,0x40,0x40,0x40,0x40,0x40,0x7F,0x40,0x40,0x40,0x00,

/*--  文字:  六  --*/
/*--  宋体12;  此字体下对应的点阵为：宽x高=16x16   --*/
0x20,0x20,0x20,0x20,0x20,0x20,0x21,0x22,0x2C,0x20,0x20,0x20,0x20,0x20,0x20,0x00,
0x00,0x40,0x20,0x10,0x0C,0x03,0x00,0x00,0x00,0x01,0x02,0x04,0x18,0x60,0x00,0x00,

/*--  文字:  日  --*/
/*--  宋体12;  此字体下对应的点阵为：宽x高=16x16   --*/
0x00,0x00,0x00,0xFE,0x82,0x82,0x82,0x82,0x82,0x82,0x82,0xFE,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0xFF,0x40,0x40,0x40,0x40,0x40,0x40,0x40,0xFF,0x00,0x00,0x00,0x00,

/*--  数字:  0  --*/
/*--  宋体12;  此字体下对应的点阵为：宽x高=8x16   --*/
0x00,0xE0,0x10,0x08,0x08,0x10,0xE0,0x00,0x00,0x0F,0x10,0x20,0x20,0x10,0x0F,0x00,

/*--  数字:  1  --*/
/*--  宋体12;  此字体下对应的点阵为：宽x高=8x16   --*/
0x00,0x00,0x10,0x10,0xF8,0x00,0x00,0x00,0x00,0x00,0x20,0x20,0x3F,0x20,0x20,0x00,

/*--  数字:  2  --*/
/*--  宋体12;  此字体下对应的点阵为：宽x高=8x16   --*/
0x00,0x70,0x08,0x08,0x08,0x08,0xF0,0x00,0x00,0x30,0x28,0x24,0x22,0x21,0x30,0x00,

/*--  数字:  3  --*/
/*--  宋体12;  此字体下对应的点阵为：宽x高=8x16   --*/
0x00,0x30,0x08,0x08,0x08,0x88,0x70,0x00,0x00,0x18,0x20,0x21,0x21,0x22,0x1C,0x00,

/*--  数字:  4  --*/
/*--  宋体12;  此字体下对应的点阵为：宽x高=8x16   --*/
0x00,0x00,0x80,0x40,0x30,0xF8,0x00,0x00,0x00,0x06,0x05,0x24,0x24,0x3F,0x24,0x24,

/*--  数字:  5  --*/
/*--  宋体12;  此字体下对应的点阵为：宽x高=8x16   --*/
0x00,0xF8,0x88,0x88,0x88,0x08,0x08,0x00,0x00,0x19,0x20,0x20,0x20,0x11,0x0E,0x00,

/*--  数字:  6  --*/
/*--  宋体12;  此字体下对应的点阵为：宽x高=8x16   --*/
0x00,0xE0,0x10,0x88,0x88,0x90,0x00,0x00,0x00,0x0F,0x11,0x20,0x20,0x20,0x1F,0x00,

/*--  数字:  7  --*/
/*--  宋体12;  此字体下对应的点阵为：宽x高=8x16   --*/
0x00,0x18,0x08,0x08,0x88,0x68,0x18,0x00,0x00,0x00,0x00,0x3E,0x01,0x00,0x00,0x00,

/*--  数字:  8  --*/
/*--  宋体12;  此字体下对应的点阵为：宽x高=8x16   --*/
0x00,0x70,0x88,0x08,0x08,0x88,0x70,0x00,0x00,0x1C,0x22,0x21,0x21,0x22,0x1C,0x00,

/*--  数字:  9  --*/
/*--  宋体12;  此字体下对应的点阵为：宽x高=8x16   --*/
0x00,0xF0,0x08,0x08,0x08,0x10,0xE0,0x00,0x00,0x01,0x12,0x22,0x22,0x11,0x0F,0x00,
};

uchar code Symbol[]={
/*--  冒号:  :  --*/
/*--  宋体12;  此字体下对应的点阵为：宽x高=8x16   --*/
0x00,0x00,0x00,0xC0,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x30,0x00,0x00,0x00,

/*--  杠号:  -  --*/
/*--  宋体12;  此字体下对应的点阵为：宽x高=8x16   --*/
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x01,0x01,0x01,0x01,0x01,0x00,

/*--  空格:     --*/
/*--  宋体12;  此字体下对应的点阵为：宽x高=8x16   --*/
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
};

sbit LCD_EN=P2^0;	  //定义LCD12864引脚位
sbit LCD_RW=P2^1;
sbit LCD_RS=P2^2;
sbit CS1=P2^3;
sbit CS2=P2^4;

sbit  DS1302_CLK = P1^1;            //实时时钟时钟线引脚
sbit  DS1302_IO  = P1^2;            //实时时钟数据线引脚
sbit  DS1302_RST = P1^0;            //实时时钟复位线引脚
sbit  LED=P1^3;
sbit  ACC0 = ACC^0;
sbit  ACC7 = ACC^7;

uchar code KEY_TABLE[]={0x11,0x21,0x41,0x81,0x12,0x22,0x42,0x82,0x14,
						0x24,0x44,0x84,0x18,0x28,0x48,0x88};	 //按键键值表
						//按键值表中前四位与按键所在列有关，后四位与按键所在行有关
						//四位二进制数中为1的那一位所在的位置就是按键所在的行或列的位置
						//比如按键0x24即0010 0100表示在第二行第一列;
						//而0x82即1000 0010表示在第一行第三列

//延时子程序
void delay_ms(uint xms)
{
	uint i,j;
	for(i=xms;i>0;i--)
	{
		for(j=110;j>0;j--);	
	}
}

//LCD忙检查子程序
void lcd_busy()
{
	uchar result;
	LCD_RS=0;
	LCD_RW=1;
	do 
	{
		LCD_data=0x00;
		LCD_EN=1;
		_nop_();
		result=LCD_data;
		LCD_EN=0;
		result=0x80&result; //检查忙信号
	}while(!(result==0x00)); //当忙信号为0时才可继续操作	 
}

//LCD写命令子程序
void lcd_wcmd(uchar cmd)
{                          
  	lcd_busy();
	LCD_RS=0; //写命令
	LCD_RW=0;
	LCD_data=cmd;
	LCD_EN=1; //利用EN 下降沿完成命令写操作
	_nop_();
	_nop_();
	LCD_EN=0;
}

void SetPage(uchar page)	//设置页码，页码为0~7
{
	page=0xb8|page;
	lcd_wcmd(page);
}

void SetStartLine(uchar startline)	//设置起始行，行号为0~63
{
	startline=0xc0|startline;
	lcd_wcmd(startline);	
}

void SetColumn(uchar column)   //设置列，列号为0~63
{
	column=column&0x3f;
	column=0x40|column;
	lcd_wcmd(column);
}

void SetOnOff(uchar onoff)	  //开关显示屏
{
	onoff=0x3e|onoff;
	lcd_wcmd(onoff);
}

//LCD写数据子程序
void lcd_wdat(uchar dat)
{                          
	lcd_busy();
	LCD_RS=1;
	LCD_RW=0;
	LCD_data=dat;
	LCD_EN=1;
	_nop_();
	_nop_();
	LCD_EN=0;
}

void SelectScreen(uchar screen)	   //选屏，screen=0,1,2
{
	switch(screen)
	{
		case 0: CS1=0;	//全屏显示
				_nop_();
				_nop_();
				_nop_();
				CS2=0;
				_nop_();
				_nop_();
				_nop_();
				break;
		case 1: CS1=0;	//左屏显示
				_nop_();
				_nop_();
				_nop_();
				CS2=1;
				_nop_();
				_nop_();
				_nop_();
				break;
		case 2: CS1=1;	//右屏显示
				_nop_();
				_nop_();
				_nop_();
				CS2=0;
				_nop_();
				_nop_();
				_nop_();
				break;
	}	
}

void ClearScreen(uchar screen)	//清屏，screen=0,1,2
{
	uchar i,j;
	SelectScreen(screen);
	for(i=0;i<8;i++)
	{
		SetPage(i);
		SetColumn(0);
		for(j=0;j<64;j++)
		{
			lcd_wdat(0x00);
		}
	}
}

void lcd_init()
{
	//P0=0x00;
	lcd_busy();	 //读忙信号，不忙则向下执行
	SelectScreen(0);
	SetOnOff(0);   //关屏
	SelectScreen(0);
	SetOnOff(1);   //开屏
	SelectScreen(0);
	ClearScreen(0);	   //清屏
	SetStartLine(0);	//开始行为0	
}			   

void Display(uchar ss,uchar page,uchar column,uchar number)
{
int i;
SelectScreen(ss); //ss为屏号
column=column&0x3f; //column为列号
SetPage(page); //page为页号，显示第number个汉字的上半部分，
//page可理解为要显示的汉字位于屏幕的第page行
SetColumn(column);
for(i=0;i<16;i++) //i为一个字里面的各个列
{
lcd_wdat(GongLi[i+32*number]); //number为字号，
//取第number个汉字的第i列数据编码值
}
SetPage(page+1); //显示第number个汉字的下半部分
SetColumn(column);
for(i=0;i<16;i++)
{
lcd_wdat(GongLi[i+32*number+16]);//取第number个汉字的下半部分
}}
void main()
{	
	uchar i;
//	Initial_DS1302();	//ds1302初始化  	
	lcd_init();	   //lcd12864初始化
	ClearScreen(0);
//	DS1302_GetTime(&CurrentTime); 	//获得当前日期和时间
//	DateToBit(&CurrentTime);   //获得当前年月日各个位上的数字
//	TimeToBit(&CurrentTime);   //获得当前时分秒各个位上的数字
	while(1)
	{
		for(i=0;i<128;i++)
		{
			SetStartLine(i);
			//ChineseDisplay(1,0,0,0);
			//ChineseDisplay(1,0,16,1);  //显示 公历 二字
			Display(1,0,0,0);
			Display(1,0,16,1);
			SelectScreen(0);
			delay_ms(50);	
		}	
	}
}
