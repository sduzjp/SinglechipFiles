C51 COMPILER V9.01   ADC0809                                                               05/04/2020 19:40:37 PAGE 1   


C51 COMPILER V9.01, COMPILATION OF MODULE ADC0809
OBJECT MODULE PLACED IN ADC0809.OBJ
COMPILER INVOKED BY: D:\keil_v4\C51\BIN\C51.EXE ADC0809.c BROWSE DEBUG OBJECTEXTEND

line level    source

   1          //程序运行后自动轮询采集ADC0808四路输入In0、In1、In2、In3的电压，并在LCD1604上显示
   2          //变量定义
   3          #include "reg51.h"
   4          #include "intrins.h"//包含_nop_()函数
   5          #define uint unsigned int
   6          #define uchar unsigned char
   7          uchar data line_data[16];//要显示的一行字符
   8          uchar code numchar[]={'0','1','2','3','4','5','6','7','8','9'};
   9          sbit LCD_RS=P3^0;
  10          sbit LCD_RW=P3^1;
  11          sbit LCD_EN=P3^4;
  12          sbit AD_CLK=P3^5;
  13          sbit Start=P3^3;
  14          sbit OE=P3^7;
  15          uint var,tmpint;
  16          long tmplong;
  17          uchar channel,samp_data,tmpchar,n;
  18          bit end_samp;
  19          
  20          //延时子程序
  21          void delay_ms(uint xms)
  22          {
  23   1              uint i,j;
  24   1              for(i=xms;i>0;i--)
  25   1              {
  26   2                      for(j=110;j>0;j--);
  27   2              }
  28   1      }
  29          
  30          //LCD忙检查子程序
  31          bit lcd_busy()
  32          {
  33   1              bit flag;
  34   1              LCD_RS=0;
  35   1              LCD_RW=1;
  36   1              LCD_EN=1;
  37   1              _nop_();
  38   1              _nop_();
  39   1              _nop_();
  40   1              _nop_();
  41   1              flag=(bit)(P1&0X80);
  42   1              LCD_EN=0;
  43   1              return flag;
  44   1      }
  45          
  46          //写命令子程序
  47          void lcd_wcmd(uchar cmd)
  48          {
  49   1              while(lcd_busy());
  50   1              LCD_RS=0;
  51   1              LCD_RW=0;
  52   1              LCD_EN=0;
  53   1              _nop_();
  54   1              _nop_();
  55   1              P1=cmd;
C51 COMPILER V9.01   ADC0809                                                               05/04/2020 19:40:37 PAGE 2   

  56   1              _nop_();
  57   1              _nop_();
  58   1              _nop_();
  59   1              _nop_();
  60   1              LCD_EN=1;
  61   1              _nop_();
  62   1              _nop_();
  63   1              _nop_();
  64   1              _nop_();
  65   1              LCD_EN=0;
  66   1              
  67   1      }
  68          
  69          //LCD清屏子程序
  70          void lcd_clr()
  71          {
  72   1              lcd_wcmd(0x01);
  73   1              delay_ms(2);
  74   1      }
  75          
  76          //写数据子程序
  77          void lcd_wdat(uchar dat)
  78          {
  79   1              while(lcd_busy());
  80   1              LCD_RS=1;
  81   1              LCD_RW=0;
  82   1              LCD_EN=0;
  83   1              _nop_();
  84   1              _nop_();
  85   1              P1=dat;
  86   1              _nop_();
  87   1              _nop_();
  88   1              _nop_();
  89   1              _nop_();
  90   1              LCD_EN=1;
  91   1              _nop_();
  92   1              _nop_();
  93   1              _nop_();
  94   1              _nop_();
  95   1              LCD_EN=0;
  96   1      }
  97          
  98          //初始化子程序
  99          void lcd_init()
 100          {
 101   1              delay_ms(5);
 102   1              lcd_wcmd(0x01);//清除LCD显示内容
 103   1              delay_ms(5);
 104   1              lcd_wcmd(0x06);//移动光标
 105   1              delay_ms(5);
 106   1              lcd_wcmd(0x0c);//显示开，关光标
 107   1              delay_ms(5);             
 108   1              lcd_wcmd(0x38);//16*4显示，5*7点阵
 109   1              delay_ms(15);//等待LCD电源稳定
 110   1      }
 111          
 112          //字符显示子程序
 113          void showstring(uchar m)
 114          {
 115   1              uchar i;
 116   1              switch(m)
 117   1              {
C51 COMPILER V9.01   ADC0809                                                               05/04/2020 19:40:37 PAGE 3   

 118   2                      case 0:
 119   2                              lcd_wcmd(0x80);//设置显示位置为第1行第0列
 120   2                              break;
 121   2                      case 1:
 122   2                              lcd_wcmd(0xc0);//设置显示位置为第2行第0列
 123   2                              break;
 124   2                      case 2:
 125   2                              lcd_wcmd(0x90);//设置显示位置为第3行第0列
 126   2                              break;
 127   2                      case 3:
 128   2                              lcd_wcmd(0xd0);//设置显示位置为第4行第0列
 129   2              }
 130   1              i=0;
 131   1              while(line_data[i]!='\0')
 132   1              {
 133   2                      lcd_wdat(line_data[i]);//加载显示字符
 134   2                      delay_ms(5);
 135   2                      i++;
 136   2              }
 137   1      }
 138          
 139          //外部中断0服务子程序
 140          void s_int0() interrupt 0       //ADC0808采集完毕
 141          {
 142   1              P0=0XFF;
 143   1              delay_ms(1);
 144   1              OE=1;           //打开ADC0808的输出功能
 145   1              samp_data=P0;
 146   1              OE=0;           //关闭ADC0808的输出功能
 147   1              end_samp=1;
 148   1              EX0=0;          //关闭外部中断0
 149   1      }
 150          
 151          //外部中断0服务子程序
 152          void s_timer1() interrupt 3             //ADC0808采集完毕
 153          {
 154   1              AD_CLK=~AD_CLK;
 155   1      }
 156          
 157          //ADC0808数据采集触发子程序
 158          void sample(uchar ch)
 159          {
 160   1              while(!end_samp);       //等待转换完成
 161   1              tmplong=(long)samp_data*5*1000;
 162   1              var=(uint)(tmplong/255);
 163   1              if(var==0)
 164   1              {
 165   2                      n=0;
 166   2                      line_data[n++]='C';
 167   2                      line_data[n++]='h';
 168   2                      line_data[n++]='0'+ch;
 169   2                      line_data[n++]=':';
 170   2                      line_data[n++]='0';
 171   2                      line_data[n++]='V';
 172   2              }
 173   1              else
 174   1              {
 175   2                      n=0;
 176   2                      line_data[n++]='C';
 177   2                      line_data[n++]='h';
 178   2                      line_data[n++]='0'+ch;
 179   2                      line_data[n++]=':';
C51 COMPILER V9.01   ADC0809                                                               05/04/2020 19:40:37 PAGE 4   

 180   2                      tmpint=var;
 181   2      
 182   2                      tmpchar=(uchar)(tmpint/1000);
 183   2                      tmpint=tmpint-(uint)tmpchar*1000;
 184   2                      line_data[n++]=numchar[tmpchar];
 185   2      
 186   2                      line_data[n++]='.';
 187   2      
 188   2                      tmpchar=(uchar)(tmpint/100);
 189   2                      tmpint=tmpint-(uint)tmpchar*100;
 190   2                      line_data[n++]=numchar[tmpchar];
 191   2      
 192   2                      tmpchar=(uchar)(tmpint/10);
 193   2                      tmpint=tmpint-(uint)tmpchar*10;
 194   2                      line_data[n++]=numchar[tmpchar];
 195   2      
 196   2                      tmpchar=(uchar)(tmpint);
 197   2                      line_data[n++]=numchar[tmpchar];
 198   2                      line_data[n++]='V';
 199   2              }
 200   1              line_data[n]='\0';
 201   1      }
 202          
 203          //主程序
 204          void main()
 205          {
 206   1              delay_ms(10);
 207   1              lcd_init();     //初始化
 208   1              lcd_clr();      //清屏
 209   1              delay_ms(2);
 210   1              channel=0;      //计算状态为状态0
 211   1              var=0;
 212   1              line_data[n]='\0';
 213   1              AD_CLK=0;
 214   1              OE=0;
 215   1      
 216   1              TMOD=0X20;      //T1工作在方式2
 217   1              TH1=0XE7;       //10KHZ
 218   1              TL1=0XE7;
 219   1              EA=1;           //打开中断总开关
 220   1              EX0=1;          //打开外部中断0
 221   1              IT0=1;          //设置中断触发方式为下降沿触发方式
 222   1              ET1=1;
 223   1              TR1=1;
 224   1              while(1)
 225   1              {
 226   2                      end_samp=0;
 227   2                      EX0=1;  //打开外部中断允许位
 228   2                      P2=channel;
 229   2                      Start=1;        //启动AD
 230   2                      delay_ms(2);
 231   2                      Start=0;        //启动信号结束
 232   2                      sample(channel);        //采集
 233   2                      showstring(channel);    //输出
 234   2                      channel++;      //通道变更
 235   2                      if(channel==4)
 236   2                      {
 237   3                              channel=0;
 238   3                      }
 239   2              }
 240   1      
 241   1      
C51 COMPILER V9.01   ADC0809                                                               05/04/2020 19:40:37 PAGE 5   

 242   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    711    ----
   CONSTANT SIZE    =     10    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     28       1
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      1       1
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
